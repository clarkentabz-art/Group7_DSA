{% extends "base.html" %}
{% block title %}Goal Tracker{% endblock %}

{% block content %}
<section class="goal-tracker-outer" style="margin: 30px;">
  <div class="goal-tracker-container" style="display:flex; gap:20px;">

    <!-- Courses Panel -->
    <div class="courses-panel" style="flex:1; max-width:250px; padding:15px; border:1px solid #ccc; border-radius:10px; background:#f9f9f9;">
      <h3>Courses</h3>
      <form method="POST" id="courseForm">
        {% for course in courses %}
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
          <button type="submit" name="course" value="{{ course }}" style="flex:1; padding:8px; {% if course==selected_course %}background:#d4edda;{% else %}background:#f0f0f0;{% endif %}; border: none;">
            {{ course }}
          </button>
          <button type="button" onclick="confirmDelete('{{ course }}')" style="background:#ff7878; padding:5px 8px; border:none; border-radius:4px; color:white;">X</button>
        </div>
        {% endfor %}
        <input type="hidden" id="delete_course_input" name="delete_course">
        <button type="submit" name="create_custom" value="1" style="width:100%; margin-top:8px; padding:8px; background:#f0d0d5; border-radius:4px;">Create Custom Goals</button>
      </form>
    </div>

    <!-- Tree Panel -->
    <div class="tree-panel" style="flex:3; height:600px; padding:20px; border:1px solid #ccc; border-radius:10px; background:#fff; overflow:auto; text-align:center;">
      <h3>Goal Tree: {{ selected_course }}</h3>
      <p style="color:green;">{{ result }}</p>

      {% if selected_course == "Learn how to sew" %}
      <div class="tree">
        <ul>
          <li><a href="#"><span>Learn how to sew</span></a>
            <ul>
              <li><a href="#"><span>Alter a T-shirt</span></a>
                <ul>
                  <li><a href="#"><span>Learn basic stitches</span></a></li>
                  <li><a href="#"><span>Learn basic fabric types</span></a></li>
                </ul>
              </li>
              <li><a href="#"><span>Create your own patterns</span></a>
                <ul>
                  <li><a href="#"><span>Sew a dress</span></a></li>
                </ul>
              </li>
              <li><a href="#"><span>Sew a pocket</span></a>
                <ul>
                  <li><a href="#"><span>Use a sewing machine</span></a></li>
                  <li><a href="#"><span>Draping techniques</span></a></li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </div>

      {% elif selected_course == "Learn how to draw" %}
      <div class="tree">
        <ul>
          <li><a href="#"><span>Learn how to draw</span></a>
            <ul>
              <li><a href="#"><span>Sketch basic shapes</span></a>
                <ul>
                  <li><a href="#"><span>Circle & Square</span></a></li>
                  <li><a href="#"><span>Own Shapes</span></a></li>
                </ul>
              </li>
              <li><a href="#"><span>Sketch Basic Forms</span></a>
                <ul>
                  <li><a href="#"><span>Cylinder and Cone</span></a></li>
                  <li><a href="#"><span>Pyramid and Cube</span></a></li>
                </ul>
              </li>
              <li><a href="#"><span>Perspective drawing</span></a>
                <ul>
                  <li><a href="#"><span>One-point perspective</span></a></li>
                  <li><a href="#"><span>Two-point perspective</span></a></li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </div>

      {% elif tree_html %}
      <div class="tree">
        {{ tree_html | safe }}
      </div>

      {% else %}
      <p>No goal tree available for this course.</p>
      {% endif %}
    </div>

    <!-- Custom Goal Panel -->
    {% if show_custom_panel %}
    <div class="custom-goal-panel" style="flex:1; padding:20px; border:1px solid #ccc; border-radius:10px; background:#fff;">
      <h3>Create / Insert Node</h3>

      <form method="POST" style="margin-bottom:12px;">
        <label>Course Title:</label>
        <input type="text" name="root_goal" style="width:100%; padding:8px; margin-bottom:8px;">
        <label>Top Goal (optional):</label>
        <input type="text" name="child_goal" style="width:100%; padding:8px; margin-bottom:8px;">
        <button type="submit" name="save_custom_tree" value="1" style="width:100%; padding:10px; background:#d4edda; border:none; border-radius:6px;">Save Tree</button>
      </form>

      <hr>
      <h4>Insert node under existing node</h4>
      <form method="POST">
        <label>Parent node:</label>
        <select name="parent_path" style="width:100%; padding:8px; margin-bottom:8px;">
          {% for val, path in nodes_with_paths %}
            <option value="{{ path }}">{{ val }} {% if path=='' %}(root){% endif %}</option>
          {% endfor %}
        </select>
        <label>Side:</label>
        <select name="side" style="width:100%; padding:8px; margin-bottom:8px;">
          <option value="L">Left</option>
          <option value="R">Right</option>
        </select>
        <label>New node value:</label>
        <input type="text" name="new_value" style="width:100%; padding:8px; margin-bottom:8px;">
        <button type="submit" style="width:100%; padding:10px; background:#e2e8f0; border:none; border-radius:6px;">Insert Node</button>
      </form>

      <form method="POST" style="margin-top:15px;">
        <button type="submit" name="finish_custom" value="1" style="width:100%; padding:10px; background:#a0e8a0; border:none; border-radius:6px;">DONE</button>
      </form>
    </div>
    {% endif %}

  </div>
</section>

<!-- Delete modal -->
<div id="deleteModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
  <div style="background:white; padding:20px; border-radius:10px; width:300px; text-align:center;">
    <h3>Delete Course?</h3>
    <p>This action cannot be undone.</p>
    <div style="display:flex; justify-content:space-between; margin-top:20px;">
      <button onclick="closeModal()" style="padding:8px 15px; background:#ccc; border:none; border-radius:6px;">Cancel</button>
      <button onclick="submitDelete()" style="padding:8px 15px; background:#ff6b6b; color:white; border:none; border-radius:6px;">Delete</button>
    </div>
  </div>
</div>

<script>
function confirmDelete(courseName) {
    document.getElementById('delete_course_input').value = courseName;
    document.getElementById('deleteModal').style.display = 'flex';
}
function closeModal() { document.getElementById('deleteModal').style.display = 'none'; }
function submitDelete() { document.querySelector('.courses-panel form').submit(); }

// Expand/collapse for custom trees
document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll('.tree li > a').forEach(link => {
        const childUl = link.parentElement.querySelector('ul');
        if(childUl){
            link.addEventListener('click', (e) => {
                e.preventDefault();
                childUl.style.display = (childUl.style.display === 'none') ? 'block' : 'none';
            });
        }
    });
});
</script>

<style>
.tree { width: 100%; height: auto; text-align: center; }
.tree ul { padding-top: 20px; position: relative; transition: .5s; }
.tree li { display: inline-table; text-align: center; list-style-type: none; position: relative; padding: 10px; transition: .5s; }
.tree li::before, .tree li::after { content: ''; position: absolute; top: 0; right: 50%; border-top: 1px solid #ccc; width: 51%; height: 10px; }
.tree li::after { right:auto; left:50%; border-left:1px solid #ccc; }
.tree li.single-node::after, .tree li.single-node::before { display:none; }
.tree li.single-node { padding-top:0; }
.tree li.root::before, .tree li.root::after { border:0 none; }
.tree li.last-node::before { border-right:1px solid #ccc; border-radius:0 5px 0 0; }
.tree li.first-node::after { border-radius:5px 0 0 0; }
.tree ul ul::before { content:''; position:absolute; top:0; left:50%; border-left:1px solid #ccc; width:0; height:20px; }
.tree li a { border:1px solid #ccc; padding:10px; display:inline-grid; border-radius:5px; text-decoration:none; transition:.5s; }
.tree li a span { border:1px solid #ccc; border-radius:5px; color:#666; padding:8px; font-size:12px; text-transform:uppercase; letter-spacing:1px; font-weight:500; }
.tree li a:hover, .tree li a:hover i, .tree li a:hover span, .tree li a:hover+ul li a { background:#c8e4f8; color:#000; border:1px solid #94a0b4; }
.tree li a:hover+ul li::after, .tree li a:hover+ul li::before, .tree li a:hover+ul::before, .tree li a:hover+ul ul::before { border-color:#94a0b4; }
</style>

{% endblock %}
